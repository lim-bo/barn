//protoc --go_out=paths=source_relative:./internal/services/pb --go-grpc_out=paths=source_relative:./internal/services/pb --grpc-gateway_out=paths=source_relative:./internal/services/pb -I./proto  proto/services.proto
//protoc --grpc-gateway_out=paths=source_relative:./internal/services/pb -I./proto proto/services.proto
syntax = "proto3";
package s3;
import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
option go_package = "github.com/lim-bo/barn/internal/services/pb";
// Messages
message Bucket {
    string id = 1;
    string name = 2;
    string owner_id = 3;
    string created_at = 4;
}

message UserCredentials {
    string username = 1;
    string password = 2;
}

message Keys {
    string access_key = 1;
    string secret_key = 2;
}

message ObjectInfo {
    string key = 1;
    int64 size = 2;
    string etag = 3;
    string last_modified = 4;
}

// Services
service BucketService {

    rpc CreateBucket(CreateBucketRequest) returns (CreateBucketResponse) {
        option (google.api.http) = {
            put: "/{name}"
            response_body: "bucket"
        };
    }

    rpc ListAllBuckets(ListAllBucketsRequest) returns (ListAllBucketsResponse) {
        option (google.api.http) = {
            get: "/"
            response_body: "buckets"
        };
    }

    rpc DeleteBucket(DeleteBucketRequest) returns (DeleteBucketResponse) {
        option (google.api.http) = {
            delete: "/{name}"
        };
    }

    rpc CheckExistBucket(CheckExistBucketRequest) returns (CheckExistBucketResponse) {
        option (google.api.http) = {
           custom: {
            kind: "HEAD"
            path: "/{name}"
           }
        };
    }
}

message CheckExistBucketRequest {
    string name = 1;
}

message CheckExistBucketResponse {}

message ListAllBucketsRequest {}

message ListAllBucketsResponse {
    repeated Bucket buckets = 1;
}

message CreateBucketRequest {
    string name = 1;
}

message CreateBucketResponse {
    Bucket bucket = 1;
}

message DeleteBucketRequest {
    string name = 1;
}

message DeleteBucketResponse {}

service AuthService {
    rpc RegisterWithKeys(google.protobuf.Empty) returns (RegisterResponse) {
        option (google.api.http) = {
            post: "/auth/register"
            response_body: "keys"
        };
    }
    rpc RegisterWithPassword(RegisterWithPasswordRequest) returns (RegisterResponse) {
        option (google.api.http) = {
            post: "/auth/register-pass"
            body: "credentials"
            response_body: "keys"
        };
    }

    rpc LoginWithPassword(LoginRequest) returns (LoginResponse) {
        option (google.api.http) = {
            post: "/auth/login"
            body: "credentials"
            response_body: "keys"
        };
    }
}

message RegisterWithPasswordRequest { 
    UserCredentials credentials = 1;
}

message RegisterResponse {
    Keys keys = 1;
}

message LoginRequest {
    UserCredentials credentials = 1;
}

message LoginResponse {
    Keys keys = 1;
}

service ObjectService {
    rpc LoadObject(LoadObjectRequest) returns (LoadObjectResponse) {
        option (google.api.http) = {
            put: "/{bucket}/{key}"
            body: "data"
            response_body: "etag"
        };
    }

    rpc GetObject(GetObjectRequest) returns (GetObjectResponse) {
        option (google.api.http) = {
            get: "/{bucket}/{key}"
            response_body: "data"
        };
    }

    rpc GetObjectMD(ObjectInfoRequest) returns (ObjectInfoResponse) {
        option (google.api.http) = {
            custom: {
            kind: "HEAD"
            path: "/{bucket}/{key}"
           }
        };
    }

    rpc DeleteObject(DeleteObjectRequest) returns (DeleteObjectResponse) {
        option (google.api.http) = {
            delete: "/{bucket}/{key}"
        };
    }

    rpc ListObjects(ListObjectsRequest) returns (ListObjectsResponse) {
        option (google.api.http) = {
            get: "/{bucket}"
            response_body: "*"
        };
    }
}

message LoadObjectRequest {
    string bucket = 1;
    string key = 2;
    bytes data = 3;
}

message LoadObjectResponse {
    string etag = 1;
}

message GetObjectRequest {
    string bucket = 1;
    string key = 2;
}

message GetObjectResponse {
    bytes data = 1;
}

message ObjectInfoRequest {
    string bucket = 1;
    string key = 2;
}

message ObjectInfoResponse {}

message DeleteObjectRequest {
    string bucket = 1;
    string key = 2;
}

message DeleteObjectResponse {}

message ListObjectsRequest {
    string bucket = 1;
    int32 limit = 2;
    int32 offset = 3;
}

message ListObjectsResponse {
    string bucket = 1;
    int32 count = 2;
    int32 limit = 3;
    int32 offset = 4;
    repeated ObjectInfo content = 5;
}